
ç•¶ä½ ä½¿ç”¨ NestJS é–‹ç™¼ API æ™‚ï¼Œã€Œ**ç‰ˆæœ¬åŒ–è·¯ç”±ï¼ˆVersioned Routingï¼‰**ã€æ˜¯ä¸€å€‹éå¸¸å¯¦ç”¨çš„åŠŸèƒ½ã€‚å®ƒè®“ä½ å¯ä»¥åœ¨ä¸å½±éŸ¿èˆŠç‰ˆ API çš„æƒ…æ³ä¸‹ï¼Œæ¨å‡ºæ–°ç‰ˆ APIï¼Œæ–¹ä¾¿ä½  **å¹³æ»‘å‡ç´š**ã€**A/B æ¸¬è©¦** æˆ– **åˆ†éšæ®µä¸Šç·šæ–°åŠŸèƒ½**ã€‚

---

## ğŸ”¹ ç‚ºä»€éº¼éœ€è¦ç‰ˆæœ¬åŒ–ï¼Ÿ

ç•¶ API å°å¤–æä¾›æœå‹™æ™‚ï¼Œéš¨è‘—éœ€æ±‚è®Šå‹•ï¼Œä½ å¯èƒ½æœƒï¼š

* ä¿®æ”¹å›å‚³æ ¼å¼ï¼ˆDTO çµæ§‹è®Šäº†ï¼‰
* è®Šæ›´é©—è­‰é‚è¼¯
* æ”¹è®Šåƒæ•¸
* æ¨æ£„æˆ–æ–°å¢æ¬„ä½

å¦‚æœä½ ç›´æ¥ä¿®æ”¹åŸæœ¬çš„ endpointï¼Œæœƒå°è‡´ **å‰ç«¯æˆ–ç¬¬ä¸‰æ–¹ç³»çµ±å£æ‰**ã€‚

æœ‰äº†ç‰ˆæœ¬åŒ–æ©Ÿåˆ¶ï¼Œä½ å°±èƒ½ï¼š

* `/v1/users` â†’ èˆŠç‰ˆæœ¬é‚è¼¯
* `/v2/users` â†’ æ–°é‚è¼¯ã€æ–°æ ¼å¼

é›™ç‰ˆæœ¬**å…±å­˜ä¸è¡çª**ï¼Œä½¿ç”¨è€…å¯ä¾ç…§éœ€è¦é¸æ“‡ç‰ˆæœ¬ã€‚

---

## ğŸ”§ å¦‚ä½•åœ¨ NestJS ä¸­ä½¿ç”¨ç‰ˆæœ¬åŒ–ï¼Ÿ

NestJS æ”¯æ´å¹¾ç¨®æ–¹å¼ä¾†åš API ç‰ˆæœ¬åŒ–ï¼š

---

### âœ… 1. URI è·¯ç”±ç‰ˆæœ¬ï¼ˆæ¨è–¦çµ¦ REST APIï¼‰

**å¯¦ä½œæ–¹å¼ï¼š**

```ts
@Controller({
  path: 'users',
  version: '1', // å°æ‡‰ /v1/users
})
export class UsersControllerV1 {
  @Get()
  getAllUsersV1() {
    return ['user1', 'user2'];
  }
}
```

```ts
@Controller({
  path: 'users',
  version: '2', // å°æ‡‰ /v2/users
})
export class UsersControllerV2 {
  @Get()
  getAllUsersV2() {
    return ['new-user1', 'new-user2'];
  }
}
```

---

### âœ… 2. é è¨­è·¯ç”±è¨­å®šç‰ˆæœ¬è­˜åˆ¥ï¼ˆglobal prefixï¼‰

ä½ éœ€è¦åœ¨ `main.ts` è£¡å•Ÿç”¨ç‰ˆæœ¬åŒ–æ”¯æ´ï¼š

```ts
const app = await NestFactory.create(AppModule);
app.setGlobalPrefix('api', {
  // æ”¯æ´ç‰ˆæœ¬åŒ–
  // é è¨­ä½¿ç”¨ URI-style versioning
  versioning: {
    type: VersioningType.URI,
  },
});
```

> ğŸ” é€™æ¨£ä½ çš„è·¯å¾‘æœƒè®Šæˆ `/api/v1/users`ã€`/api/v2/users`

---

### âœ… 3. Header ç‰ˆæœ¬åŒ–ï¼ˆé©åˆ API Gateway è½‰ç™¼ï¼‰

```ts
app.enableVersioning({
  type: VersioningType.HEADER,
  header: 'x-api-version',
});
```

**å‘¼å«æ–¹å¼ï¼š**

```http
GET /users
x-api-version: 1
```

é€™æ¨£ä½ å¯ä»¥æ ¹æ“š header æ±ºå®šä½¿ç”¨å“ªå€‹ controllerã€‚

---

### âœ… 4. Media Type ç‰ˆæœ¬åŒ–ï¼ˆè¼ƒå°‘ç”¨ï¼‰

```ts
app.enableVersioning({
  type: VersioningType.MEDIA_TYPE,
  key: 'v',
});
```

**å‘¼å«æ–¹å¼ï¼š**

```http
Accept: application/json;v=1
```

---

## ğŸ§ª ç¯„ä¾‹ï¼šåŒä¸€å€‹ route æ”¯æ´å¤šç‰ˆæœ¬

ä½ ç”šè‡³å¯ä»¥åœ¨**åŒä¸€å€‹ controller** ä¸­å¯«å¤šå€‹ç‰ˆæœ¬çš„æ–¹æ³•ï¼š

```ts
@Controller('users')
export class UsersController {
  @Get()
  @Version('1')
  getV1() {
    return 'this is v1';
  }

  @Get()
  @Version('2')
  getV2() {
    return 'this is v2';
  }
}
```

---

## ğŸ§  å°æŠ€å·§èˆ‡æ³¨æ„äº‹é …

| é¡å‹                       | å„ªé»                   | ç¼ºé»           |
| ------------------------ | -------------------- | ------------ |
| URI (`/v1/users`)        | æœ€æ¸…æ¥šã€æœ€å¸¸è¦‹              | URL çµæ§‹æ¯”è¼ƒé•·    |
| Header (`x-api-version`) | æ¸…çˆ½ URLã€æ–¹ä¾¿ gateway æ§åˆ¶ | ä¸ç›´è§€ã€ä¸æ˜“ debug |
| Media Type               | RESTful purist å–œæ„›    | è¼ƒå†·é–€ã€æ”¯æ´å·®      |
| Controller @Version()    | éˆæ´»æ§åˆ¶                 | å¤§å‹å°ˆæ¡ˆæœƒæ··äº‚      |

---

## âœ… çµè«–

NestJS çš„ç‰ˆæœ¬åŒ–æ”¯æ´æ˜¯**ä¼æ¥­ç´š API ç¶­é‹çš„å¿…å‚™åŠŸèƒ½**ï¼Œå¹«åŠ©ä½ ï¼š

* åŒæ™‚æ”¯æ´èˆŠå®¢æˆ¶èˆ‡æ–°è¦éœ€æ±‚
* å®‰å…¨ä¸Šç·šæ–°åŠŸèƒ½
* å¹³æ»‘åšå‘å¾Œä¸ç›¸å®¹çš„è®Šæ›´

---

å¦‚æœä½ å‘Šè¨´æˆ‘ä½ ç›®å‰çš„ API åŠŸèƒ½å’Œæœªä¾†å‡ç´šéœ€æ±‚ï¼Œæˆ‘å¯ä»¥å¹«ä½ å…·é«”è¦åŠƒç‰ˆæœ¬åŒ–ç­–ç•¥ï¼ˆex: å“ªäº›åŠŸèƒ½éœ€è¦æ‹† v2ã€æ€éº¼ä½ˆç½²ã€å¦‚ä½•è®“ Swagger æ–‡ä»¶ä¹Ÿæ”¯æ´å¤šç‰ˆæœ¬ï¼‰ã€‚è¦å—ï¼Ÿ




å¾ˆå¥½ï¼Œè®“æˆ‘å€‘ç”¨**å¯¦éš›ç¯„ä¾‹**ä¾†èªªæ˜ã€Œä½ æ‡‰è©²æ€éº¼å¯¦è¸ NestJS çš„ç‰ˆæœ¬åŒ–ã€ã€‚

---

## ğŸ¯ ä½ çš„æƒ…å¢ƒå‡è¨­ï¼ˆä¾‹å­ï¼‰

ä½ æœ‰ä¸€å€‹ç¾æœ‰ APIï¼š

```http
GET /users
```

å›å‚³ï¼š

```json
[
  { "id": 1, "name": "Amy" },
  { "id": 2, "name": "Bob" }
]
```

æŸä¸€å¤©ä½ éœ€è¦æ–°å¢ email æ¬„ä½ï¼Œæˆ–æ ¼å¼å¤§æ”¹ï¼Œä¸å¸Œæœ›è€å®¢æˆ¶å£æ‰ï¼Œå› æ­¤ä½ æƒ³æ¨ä¸€å€‹æ–°ç‰ˆæœ¬ã€‚

---

## âœ… å¯¦ä½œæ­¥é©Ÿ

---

### âœ… ç¬¬ 1 æ­¥ï¼šåœ¨ `main.ts` å•Ÿç”¨ç‰ˆæœ¬æ§åˆ¶

```ts
// main.ts
import { VersioningType } from '@nestjs/common';

const app = await NestFactory.create(AppModule);

app.setGlobalPrefix('api'); // è¨­å®šå…±ç”¨å‰ç¶´ /api

app.enableVersioning({
  type: VersioningType.URI, // ä½¿ç”¨ URI ç‰ˆæœ¬æ§åˆ¶ï¼Œå°æ‡‰ /v1/, /v2/
});
```

é€™è¡¨ç¤ºä½ å°‡ä¾†çš„ API æ˜¯é€™æ¨£çš„ï¼š

* `GET /api/v1/users` ğŸ‘‰ èˆŠç‰ˆ
* `GET /api/v2/users` ğŸ‘‰ æ–°ç‰ˆ

---

### âœ… ç¬¬ 2 æ­¥ï¼šå»ºç«‹ `UsersController` çš„å…©å€‹ç‰ˆæœ¬

#### ğŸ“‚ ç›®éŒ„çµæ§‹å»ºè­°ï¼š

```
src/
â”œâ”€â”€ users/
â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â””â”€â”€ users.controller.ts
â”‚   â”œâ”€â”€ v2/
â”‚   â”‚   â””â”€â”€ users.controller.ts
```

#### `v1/users.controller.ts`

```ts
import { Controller, Get } from '@nestjs/common';

@Controller({ path: 'users', version: '1' })
export class UsersControllerV1 {
  @Get()
  getUsers() {
    return [
      { id: 1, name: 'Amy' },
      { id: 2, name: 'Bob' }
    ];
  }
}
```

#### `v2/users.controller.ts`

```ts
import { Controller, Get } from '@nestjs/common';

@Controller({ path: 'users', version: '2' })
export class UsersControllerV2 {
  @Get()
  getUsers() {
    return [
      { id: 1, name: 'Amy', email: 'amy@example.com' },
      { id: 2, name: 'Bob', email: 'bob@example.com' }
    ];
  }
}
```

---

### âœ… ç¬¬ 3 æ­¥ï¼šåœ¨ Module ä¸­è¨»å†Šå…©å€‹ç‰ˆæœ¬çš„ Controller

```ts
// users/users.module.ts
import { Module } from '@nestjs/common';
import { UsersControllerV1 } from './v1/users.controller';
import { UsersControllerV2 } from './v2/users.controller';

@Module({
  controllers: [UsersControllerV1, UsersControllerV2],
})
export class UsersModule {}
```

---

### âœ… ç¬¬ 4 æ­¥ï¼šæ•´åˆåˆ° AppModule

```ts
// app.module.ts
import { Module } from '@nestjs/common';
import { UsersModule } from './users/users.module';

@Module({
  imports: [UsersModule],
})
export class AppModule {}
```

---

### âœ… çµæœæ¸¬è©¦

* **èˆŠç‰ˆï¼š**

  ```
  curl http://localhost:3000/api/v1/users
  ```

  è¼¸å‡ºï¼š

  ```json
  [ { "id": 1, "name": "Amy" }, { "id": 2, "name": "Bob" } ]
  ```

* **æ–°ç‰ˆï¼š**

  ```
  curl http://localhost:3000/api/v2/users
  ```

  è¼¸å‡ºï¼š

  ```json
  [ { "id": 1, "name": "Amy", "email": "amy@example.com" }, { "id": 2, "name": "Bob", "email": "bob@example.com" } ]
  ```

---

## ğŸ“˜ è£œå……ï¼šSwagger ä¹Ÿå¯ä»¥æ”¯æ´ç‰ˆæœ¬

ä½ ä¹Ÿå¯ä»¥è®“ Swagger æ–‡ä»¶é¡¯ç¤ºæ¯å€‹ç‰ˆæœ¬ï¼ˆéœ€è¦é¡å¤–è¨­å®šï¼‰ï¼Œå¦‚æœä½ æœ‰éœ€è¦æˆ‘å¯ä»¥å¹«ä½ è¨­å®š Swagger å¤šç‰ˆæœ¬ã€‚

---

## âœ… å°çµ

| ç›®æ¨™           | æ–¹å¼                         |
| ------------ | -------------------------- |
| å°åŒä¸€è³‡æºæ”¯æ´å¤šç‰ˆæœ¬   | å»ºç«‹å¤šå€‹ Controllerï¼ŒæŒ‡å®š version |
| å°å¤–æä¾›æ¸…æ™°è·¯ç”±     | ä½¿ç”¨ URI ç‰ˆæœ¬åŒ– `/v1/`ã€`/v2/`   |
| ä¿è­·è€å®¢æˆ¶ä½¿ç”¨çš„ API | ä¸å‹•åŸæœ¬ v1 controllerï¼Œæ–°å¢ v2   |

---

ä½ åªè¦ç…§ä¸Šé¢çš„æ­¥é©Ÿè·Ÿç›®éŒ„æ‹†æ³•ï¼Œå°±èƒ½è¼•é¬†ç®¡ç†å¤šå€‹ç‰ˆæœ¬äº†ã€‚å¦‚æœä½ å¸Œæœ›æˆ‘æ ¹æ“šä½ ç¾åœ¨çš„ controller ç›´æ¥å¹«ä½ é‡æ§‹æˆç‰ˆæœ¬åŒ–çµæ§‹ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¹«ä½ åšã€‚ä½ æƒ³è©¦è©¦å—ï¼Ÿ
