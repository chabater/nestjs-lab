å¤ªå¥½äº†ï¼Œæˆ‘ä¾†ä¸€æ¬¡çµ¦ä½ å®Œæ•´èªªæ˜ ğŸ‘‡

---

## ğŸ”§ å¥—ä»¶ä½¿ç”¨æ¨£æ¿ï¼ˆå« API å‘¼å«æ¬¡æ•¸èˆ‡å»¶é²æ™‚é–“ç›£æ§ï¼‰

### âœ… å®‰è£å¥—ä»¶ï¼ˆå¦‚æœé‚„æ²’è£ï¼‰ï¼š

```bash
npm install @willsoto/nestjs-prometheus prom-client
```

---

### ğŸ“ app.module.tsï¼š

```ts
import { Module } from '@nestjs/common';
import { PrometheusModule } from '@willsoto/nestjs-prometheus';
import { APP_INTERCEPTOR } from '@nestjs/core';
import { MetricsInterceptor } from './metrics.interceptor';
import { ExampleController } from './example.controller';
import { ExampleService } from './example.service';

@Module({
  imports: [PrometheusModule.register()],
  controllers: [ExampleController],
  providers: [
    ExampleService,
    {
      provide: APP_INTERCEPTOR,
      useClass: MetricsInterceptor, // å°‡ MetricsInterceptor è¨»å†Šç‚ºå…¨åŸŸæ””æˆªå™¨
    },
  ],
})
export class AppModule {}
```

---

### ğŸ“ metrics.interceptor.tsï¼ˆæ””æˆªå™¨ï¼šå»¶é² + æ¬¡æ•¸ï¼‰

```ts
import {
  CallHandler,
  ExecutionContext,
  Injectable,
  NestInterceptor,
} from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';
import { Histogram, Counter, register } from 'prom-client';

const httpRequestDuration = new Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status_code'],
  buckets: [0.1, 0.5, 1, 2, 5],
});

const httpRequestCounter = new Counter({
  name: 'http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'route', 'status_code'],
});

@Injectable()
export class MetricsInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const now = Date.now();
    const req = context.switchToHttp().getRequest();
    const method = req.method;
    const route = req.route?.path || req.url;

    return next.handle().pipe(
      tap(() => {
        const statusCode = context.switchToHttp().getResponse().statusCode;

        httpRequestDuration
          .labels(method, route, String(statusCode))
          .observe((Date.now() - now) / 1000);

        httpRequestCounter
          .labels(method, route, String(statusCode))
          .inc();
      }),
    );
  }
}
```

---

### ğŸ“ example.controller.tsï¼ˆæ¸¬è©¦ç”¨ï¼‰

```ts
import { Controller, Get } from '@nestjs/common';
import { ExampleService } from './example.service';

@Controller('example')
export class ExampleController {
  constructor(private readonly exampleService: ExampleService) {}

  @Get()
  getExample() {
    return this.exampleService.doSomething();
  }
}
```

---

## ğŸ“Š `/metrics` é è¨­æœƒæœ‰å“ªäº› Prometheus æŒ‡æ¨™ï¼Ÿ

é€™äº›æ˜¯ Prometheus client library é è¨­å°±æœƒè¼¸å‡ºçš„ç³»çµ±æŒ‡æ¨™ï¼ˆç”± `prom-client` æä¾›ï¼‰ï¼š

| æŒ‡æ¨™åç¨±                               | èªªæ˜                     |
| ---------------------------------- | ---------------------- |
| `process_cpu_user_seconds_total`   | ä½¿ç”¨è€… CPU æ™‚é–“             |
| `process_cpu_system_seconds_total` | ç³»çµ± CPU æ™‚é–“              |
| `process_resident_memory_bytes`    | ä½¿ç”¨ä¸­çš„è¨˜æ†¶é«”                |
| `process_start_time_seconds`       | ç¨‹åºå•Ÿå‹•æ™‚é–“ï¼ˆç§’ï¼‰              |
| `nodejs_eventloop_lag_seconds`     | Node.js event loop lag |
| `nodejs_heap_size_used_bytes`      | ä½¿ç”¨çš„ heap å¤§å°            |
| `nodejs_gc_runs_total`             | åƒåœ¾å›æ”¶æ¬¡æ•¸                 |

> ğŸ“ é€™äº›éƒ½æ˜¯ä½ **ä¸éœ€è¦é¡å¤–è¨­å®š**å°±èƒ½ç›£æ§çš„è³‡æºå¥åº·èˆ‡æ•ˆèƒ½æŒ‡æ¨™ã€‚

---

## ğŸ“Œ ç‰ˆæœ¬æ§åˆ¶æ˜¯å¦å¯æ”¯æ´ï¼Ÿ

Prometheus æŒ‡æ¨™æœ¬èº«æ²’æœ‰â€œç‰ˆæœ¬â€çš„æ¦‚å¿µï¼Œä½† **ä½ å¯ä»¥é€é Label ä¾†é”æˆç‰ˆæœ¬åŒ–çš„ç®¡ç†**ï¼Œä¾‹å¦‚ï¼š

```ts
const httpRequestCounter = new Counter({
  name: 'http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'route', 'status_code', 'version'],
});
```

ç„¶å¾Œåœ¨æ””æˆªå™¨ä¸­åŠ ä¸Š version labelï¼š

```ts
httpRequestCounter
  .labels(method, route, String(statusCode), 'v1')
  .inc();
```

é€™æ¨£ä½ å°±å¯ä»¥åœ¨ Prometheus æˆ– Grafana ä¸­ä¾ç…§ `version="v1"` æˆ– `v2` åšåˆ†æµçµ±è¨ˆã€‚

---

### âœ… å»ºè­°çš„ç‰ˆæœ¬åŒ–å¯¦è¸ï¼š

å¦‚æœä½ ä½¿ç”¨ NestJS çš„ç‰ˆæœ¬åŒ–è·¯ç”±ï¼ˆä¾‹å¦‚ `/v1/users` vs `/v2/users`ï¼‰ï¼Œå¯ä»¥è‡ªå‹•å¾ URL æ¨å°å‡º version labelï¼š

```ts
const version = route.split('/')[1]; // ä¾‹å¦‚å¾ "/v1/users" æ‹¿åˆ° "v1"
```

---

å¦‚æœä½ æœ‰éœ€æ±‚ï¼Œæˆ‘å¯ä»¥å¹«ä½ æ”¹å¯«æˆæ”¯æ´ã€Œå‹•æ…‹è‡ªå‹•åˆ¤æ–·ç‰ˆæœ¬ã€çš„ label åŠ å…¥å–”ï¼

è¦æˆ‘å¹«ä½ åŠ ä¸Šå—ï¼Ÿæˆ–æ˜¯ä½ ç¾åœ¨çš„ API æœ‰ä½¿ç”¨ç‰ˆæœ¬è·¯ç”±å—ï¼Ÿæˆ‘å¯ä»¥ç›´æ¥é‡å°ä½ çš„è¨­è¨ˆåšå»ºè­° âœ…




éå¸¸å¥½ï¼ä»¥ä¸‹æ˜¯**æœ€çµ‚å¼·åŒ–ç‰ˆçš„ `MetricsInterceptor`**ï¼ŒåŠŸèƒ½åŒ…å«ï¼š

---

### âœ… åŠŸèƒ½ç¸½è¡¨ï¼š

| åŠŸèƒ½               | èªªæ˜                                  |
| ---------------- | ----------------------------------- |
| âœ”ï¸ å‹•æ…‹æ“·å–ç‰ˆæœ¬è™Ÿ       | è‡ªå‹•å¾ URL ä¸­è§£æ `/v1/`ã€`/api/v2/` ç­‰ç‰ˆæœ¬å­—ä¸² |
| âœ”ï¸ è‡ªè¨‚ prefix éæ¿¾  | åªçµ±è¨ˆ `/api` è·¯å¾‘é–‹é ­çš„è«‹æ±‚                  |
| âœ”ï¸ æ’é™¤ `/metrics` | é¿å… Prometheus è‡ªå·±æŠ“ `/metrics` æ™‚ä¹Ÿè¢«è¨˜éŒ„  |

---

## âœ… æœ€çµ‚ç‰ˆ `metrics.interceptor.ts`

```ts
import {
  CallHandler,
  ExecutionContext,
  Injectable,
  NestInterceptor,
} from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';
import { Histogram, Counter } from 'prom-client';

// Prometheus æŒ‡æ¨™å®šç¾©
const httpRequestDuration = new Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status_code', 'version'],
  buckets: [0.1, 0.5, 1, 2, 5],
});

const httpRequestCounter = new Counter({
  name: 'http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'route', 'status_code', 'version'],
});

// âœ… å¯è‡ªè¨‚ä½ è¦ç›£æ§çš„è·¯å¾‘å‰ç¶´
const MONITORED_PREFIX = '/api';

@Injectable()
export class MetricsInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const now = Date.now();
    const request = context.switchToHttp().getRequest();
    const response = context.switchToHttp().getResponse();

    const method = request.method;
    const url = request.originalUrl || request.url;
    const route = request.route?.path || url;

    // âœ… æ’é™¤ /metrics endpoint è‡ªå·±
    if (url.startsWith('/metrics')) {
      return next.handle();
    }

    // âœ… åªç›£æ§ä»¥ MONITORED_PREFIX é–‹é ­çš„è«‹æ±‚
    if (!url.startsWith(MONITORED_PREFIX)) {
      return next.handle();
    }

    const version = this.extractVersionFromUrl(url);

    return next.handle().pipe(
      tap(() => {
        const statusCode = response.statusCode;

        httpRequestDuration
          .labels(method, route, String(statusCode), version)
          .observe((Date.now() - now) / 1000);

        httpRequestCounter
          .labels(method, route, String(statusCode), version)
          .inc();
      }),
    );
  }

  private extractVersionFromUrl(url: string): string {
    const match = url.match(/\/(v\d+)(\/|$)/i);
    return match ? match[1] : 'unknown';
  }
}
```

---

## ğŸ§ª ç¯„ä¾‹æƒ…å¢ƒèªªæ˜

| è«‹æ±‚è·¯å¾‘             | æ˜¯å¦çµ±è¨ˆ | version |
| ---------------- | ---- | ------- |
| `/api/v1/users`  | âœ… æ˜¯  | `v1`    |
| `/api/v2/orders` | âœ… æ˜¯  | `v2`    |
| `/v1/internal`   | âŒ å¦  | -       |
| `/metrics`       | âŒ å¦  | -       |
| `/healthz`       | âŒ å¦  | -       |

---

## ğŸ›  è‹¥ä½ å¸Œæœ› prefix å¯å‹•æ…‹è¨­å®š

ä½ å¯ä»¥å¾ `.env` è¨­å®šï¼š

```env
MONITOR_PREFIX=/api
```

ç„¶å¾Œåœ¨ç¨‹å¼ä¸­ç”¨ï¼š

```ts
const MONITORED_PREFIX = process.env.MONITOR_PREFIX || '/api';
```

---

æ˜¯å¦ä¹Ÿæƒ³åŠ ä¸Šï¼š

* åªè¨˜éŒ„ç‰¹å®š HTTP æ–¹æ³•ï¼ˆå¦‚ GET / POSTï¼‰ï¼Ÿ
* æ’é™¤ç‰¹å®š Status Codeï¼ˆå¦‚ 4xx ä¸è¨˜éŒ„ï¼‰ï¼Ÿ

æˆ‘å¯ä»¥å†å¹«ä½ å‡ç´šç‚ºé€²éšæ¢ä»¶ç‰ˆ âœ…



ğŸ“ˆ Prometheus/Grafana æŸ¥è©¢ç¯„ä¾‹ï¼š
sum by (version) (rate(http_requests_total[5m]))
é€™æ¨£ä½ å°±èƒ½çµ±è¨ˆï¼š

æ¯ 5 åˆ†é˜å…§ï¼Œæ¯å€‹ç‰ˆæœ¬çš„ API å‘¼å«æ¬¡æ•¸

avg by (version) (rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m]))
é€™æ˜¯ï¼š

æ¯å€‹ç‰ˆæœ¬å¹³å‡çš„ API å»¶é²æ™‚é–“ï¼ˆç§’ï¼‰


å¾ˆæ£’çš„å•é¡Œï¼Œç°¡çŸ­å›ç­”æ˜¯ï¼š

> **ä¸æœƒç›´æ¥è¡çªï¼Œä½†éœ€è¦å°å¿ƒé¿å…ã€Œé‡è¤‡ç´€éŒ„ã€æˆ–ã€ŒæŒ‡æ¨™é‡è¤‡å‘½åã€çš„å•é¡Œã€‚**

---

## ğŸ” OpenTelemetry èˆ‡ Prometheus çš„é—œä¿‚

* **OpenTelemetryï¼ˆOTelï¼‰** æ˜¯è§€æ¸¬æ€§æ¨™æº–ï¼Œå¯æ”¯æ´ traceï¼ˆè¿½è¹¤ï¼‰ã€metricï¼ˆæŒ‡æ¨™ï¼‰ã€logï¼ˆæ—¥èªŒï¼‰ã€‚
* **Prometheus** æ˜¯ä¸€ç¨®æŒ‡æ¨™æ‹‰å–ï¼ˆpull-basedï¼‰çš„ç³»çµ±ã€‚
* å…©è€…å¯ä»¥æ•´åˆï¼Œä½† **ä½ ç¾åœ¨ä½¿ç”¨çš„ `prom-client`ï¼ˆ+ `@willsoto/nestjs-prometheus`ï¼‰æ˜¯ç›´æ¥ç”¨ Node.js SDK è¨˜éŒ„ metrics**ï¼Œé€™æœƒå’Œ OpenTelemetry è¨˜éŒ„ metric æ™‚**ä½¿ç”¨ä¸åŒçš„å¾Œç«¯**ã€‚

---

## âš ï¸ å¯èƒ½çš„è¡çªæˆ–æ³¨æ„äº‹é …

| é¡å‹                  | æè¿°                                                                          | è§£æ³•                                                                     |
| ------------------- | --------------------------------------------------------------------------- | ---------------------------------------------------------------------- |
| â— **æŒ‡æ¨™åç¨±è¡çª**        | å¦‚æœ OTel ä¹Ÿç´€éŒ„äº†åç‚º `http_requests_total` çš„æŒ‡æ¨™ï¼ŒPrometheus æœƒå ±éŒ¯ï¼šã€Œduplicate metricsã€ | âœ… ç¢ºä¿å‘½åç¨ç«‹ï¼Œä¾‹å¦‚ `otel_http_requests_total` vs `custom_http_requests_total` |
| â— **è³‡æ–™é‡è¤‡**          | åŒä¸€ç­† HTTP è«‹æ±‚ï¼ŒåŒæ™‚è¢« OTel èˆ‡ Interceptor è¨˜éŒ„ä¸€æ¬¡                                     | âœ… æ±ºå®šä½ åªç”¨å“ªä¸€å€‹è¨˜éŒ„ HTTP æŒ‡æ¨™ï¼›æˆ–ç”¨ OTel è™•ç† trace + metricsï¼ŒInterceptor å°ˆæ³¨æ–¼è‡ªè¨‚é‚è¼¯    |
| âš ï¸ **ä¸åŒ export æ¨¡å¼** | `prom-client` æ˜¯ Pull æ¨¡å¼ï¼›OpenTelemetry æœ‰æ”¯æ´ Push / Exporter æ¨¡å¼ï¼ˆä¾‹å¦‚ OTLPï¼‰       | âœ… å¦‚æœä½ æ˜¯ç´” Prometheus ç’°å¢ƒï¼Œç”¨ `prom-client` è¼ƒè‡ªç„¶ï¼›å¦å‰‡å»ºè­°è®“ OTel çµ±ä¸€æ”¶é›† metrics      |

---

## âœ… å»ºè­°ä½ é€™æ¨£åšï¼š

### A. å¦‚æœä½ åªæ˜¯è¦ Prometheus dashboard + Grafanaï¼š

âœ”ï¸ ç¹¼çºŒä½¿ç”¨ `@willsoto/nestjs-prometheus` + `prom-client`
âœ”ï¸ **ä¸éœ€è¦ OTel ä¾†è™•ç† metrics**ï¼ˆåªç”¨å®ƒ trace æ¯”è¼ƒå¥½ï¼‰

### B. å¦‚æœä½ å·²ç¶“æœ‰ OpenTelemetry ä¸¦æ‰“ç®—ç”¨å®ƒæ”¶é›† **æ‰€æœ‰è§€æ¸¬è³‡æ–™ï¼ˆtrace + metricï¼‰**ï¼š

âœ”ï¸ ä½ æ‡‰è©² **ä¸è¦åŒæ™‚ä½¿ç”¨ prom-client è‡ªè¡Œè¼¸å‡º /metrics endpoint**
âœ”ï¸ æ”¹ç”¨ OTel çš„ Metric exporterï¼Œä¾‹å¦‚ [@opentelemetry/exporter-prometheus](https://www.npmjs.com/package/@opentelemetry/exporter-prometheus)

---

## ğŸ’¡ Bonusï¼šæ€éº¼ç”¨ OTel ç”¢ç”Ÿ Prometheus metricsï¼Ÿ

å¦‚æœä½ è¦èµ° B è·¯ç·šï¼Œå¯ä»¥é€™æ¨£è¨­å®š exporterï¼š

```ts
import { PrometheusExporter } from '@opentelemetry/exporter-prometheus';
import { MeterProvider } from '@opentelemetry/sdk-metrics';

const exporter = new PrometheusExporter({ port: 9464 }, () => {
  console.log('Prometheus scrape endpoint: http://localhost:9464/metrics');
});

const meterProvider = new MeterProvider();
meterProvider.addMetricReader(exporter);
```

é€™æ¨£ Prometheus å°±æŠ“ `http://localhost:9464/metrics`ï¼Œç”± OTel è² è²¬ç”¢ç”ŸæŒ‡æ¨™ã€‚

---

## âœ… çµè«–

| ä½ æƒ³è¦çš„çµæœ                           | å»ºè­°                                                       |
| -------------------------------- | -------------------------------------------------------- |
| å¿«é€Ÿéƒ¨ç½² Prometheus metrics          | ç¹¼çºŒç”¨ `@willsoto/nestjs-prometheus`ï¼Œ**ä¸è¦ç”¨ OTel æ”¶ metrics** |
| å…¨é¢å°å…¥è§€æ¸¬æ€§ï¼ˆlogs + traces + metricsï¼‰ | ç”¨ OpenTelemetryï¼Œ**é—œæ‰ prom-client çš„ metrics endpoint**    |
| å…©è€…éƒ½ç”¨                             | å°å¿ƒæŒ‡æ¨™åç¨±ã€é¿å…é›™é‡ç´€éŒ„                                            |

---

ğŸ‘‰ å¦‚æœä½ å‘Šè¨´æˆ‘ä½ ç›®å‰æ˜¯å¦æœ‰åœ¨ç”¨ OpenTelemetry trace/exporterï¼Œæˆ‘å¯ä»¥å¹«ä½ è¨­è¨ˆä¸€å€‹ä¸è¡çªçš„æ¶æ§‹å»ºè­°ã€‚æ˜¯å¦éœ€è¦ï¼Ÿ
