ç›®éŒ„çµæ§‹å»ºè­°
arduino
src/
â””â”€â”€ config/
    â”œâ”€â”€ server-default.ts        # é è¨­è¨­å®šå€¼ + å‹åˆ¥
    â”œâ”€â”€ server-config.service.ts # è¨­å®šæœå‹™ï¼ˆç†±é‡è¼‰ + è®€å– + æŸ¥è©¢ï¼‰
    â””â”€â”€ config.module.ts         # å¯æ³¨å…¥çš„ Nest æ¨¡çµ„
âœ… server-default.ts
ts
export const SERVER_DEFAULT = {
  DEV: {
    'MY-LAB-ENV': {
      SERVER1: '8.8.8.8',
      SERVER2: '9.9.9.9',
    },
  },
  STAGE: {
    'MY-STAGE-ENV': {
      SERVER1: '1.1.1.1',
      SERVER2: '2.2.2.2',
    },
  },
} as const;

export type ServerConfig = typeof SERVER_DEFAULT;
export type EnvKey = keyof ServerConfig;
âœ… server-config.service.ts
ts
import { Injectable, Logger } from '@nestjs/common';
import * as fs from 'fs';
import * as chokidar from 'chokidar';
import * as path from 'path';
import { SERVER_DEFAULT, ServerConfig, EnvKey } from './server-default';

@Injectable()
export class ServerConfigService {
  private readonly logger = new Logger(ServerConfigService.name);
  private readonly configPath = path.resolve('/etc/config/server.json'); // å¯æ”¹ç‚ºå…¶ä»–ä½ç½®
  private config: ServerConfig = SERVER_DEFAULT;

  constructor() {
    this.loadConfig();
    this.watchConfig();
  }

  private loadConfig() {
    try {
      const raw = fs.readFileSync(this.configPath, 'utf-8');
      const parsed = JSON.parse(raw) as Partial<ServerConfig>;
      this.config = { ...SERVER_DEFAULT, ...parsed };
      this.logger.log('âœ… Server config loaded');
    } catch (err) {
      this.logger.error('âŒ Failed to load config: ' + err.message);
    }
  }

  private watchConfig() {
    chokidar.watch(this.configPath, {
      usePolling: true,
      interval: 1000,
    }).on('change', () => {
      this.logger.log('ğŸ”„ server.json changed, reloading...');
      this.loadConfig();
    });
  }

  getServerIpSafe(env: EnvKey, cluster: string, serverName: string): string | undefined {
    return this.config?.[env]?.[cluster]?.[serverName];
  }

  getServerIpStrict(env: EnvKey, cluster: string, serverName: string): string {
    const ip = this.getServerIpSafe(env, cluster, serverName);
    if (!ip) {
      throw new Error(`â—Missing IP for ${env}.${cluster}.${serverName}`);
    }
    return ip;
  }

  // å¯ç”¨ä¾†æŸ¥çœ‹æ•´ä»½ config
  getAll(): ServerConfig {
    return this.config;
  }
}
âœ… config.module.ts
ts
import { Module } from '@nestjs/common';
import { ServerConfigService } from './server-config.service';

@Module({
  providers: [ServerConfigService],
  exports: [ServerConfigService],
})
export class ConfigModule {}
âœ… ä½¿ç”¨æ–¹å¼ï¼ˆå…¶ä»–æ¨¡çµ„æ³¨å…¥ï¼‰
ts
import { Injectable } from '@nestjs/common';
import { ServerConfigService } from './config/server-config.service';

@Injectable()
export class SomeService {
  constructor(private readonly configService: ServerConfigService) {}

  doSomething() {
    const ip = this.configService.getServerIpSafe('DEV', 'MY-LAB-ENV', 'SERVER1') || '127.0.0.1';
    const dbIp = this.configService.getServerIpStrict('STAGE', 'MY-STAGE-ENV', 'SERVER1');
    console.log('Using IP:', ip, dbIp);
  }
}
âœ… Kubernetes ConfigMap YAML ç¯„ä¾‹ï¼ˆserver.jsonï¼‰
yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: server-config
data:
  server.json: |
    {
      "DEV": {
        "MY-LAB-ENV": {
          "SERVER1": "10.0.0.1",
          "SERVER2": "10.0.0.2"
        }
      }
    }
Volume æ›è¼‰ç¯„ä¾‹ï¼š

yaml
volumeMounts:
  - name: config
    mountPath: /etc/config/server.json
    subPath: server.json

volumes:
  - name: config
    configMap:
      name: server-config
âœ… æ“´å……å»ºè­°ï¼ˆå¯é¸ï¼‰
åŠ ä¸Š .getAllClusters(env: EnvKey): string[]

åŠ ä¸Š .getAllEnvs(): EnvKey[]

ç™¼é€ EventBus äº‹ä»¶è®“å…¶ä»–æ¨¡çµ„ã€Œè¨‚é–±è¨­å®šè®ŠåŒ–ã€

è‡ªå‹•è¨˜éŒ„å“ªäº›è¨­å®šè¢«èª°æŸ¥è©¢éï¼ˆåŠ å¼·è§€å¯Ÿï¼‰







ç›®æ¨™
æ¸¬è©¦ chokidar æª”æ¡ˆç›£æ§æœ‰æ­£ç¢ºè§¸ç™¼ loadConfig()

ä¸çœŸçš„ç›£æ§æª”æ¡ˆï¼Œè€Œæ˜¯ç”¨ mock æ¨¡æ“¬ chokidar.watch().on('change', ...)

é€é spy æˆ– mock ç¢ºèª loadConfig() è¢«å‘¼å«æ¬¡æ•¸

âœ… æ¸¬è©¦é—œéµæŠ€å·§ï¼šmock chokidar
ğŸ§± ç¬¬ä¸€æ­¥ï¼šMock chokidar module
åœ¨ __mocks__/chokidar.ts ä¸‹å»ºç«‹è‡ªè¨‚ mockï¼š

ts
// __mocks__/chokidar.ts
const chokidarMock = {
  watch: jest.fn(() => ({
    on: jest.fn(),
  })),
};

export default chokidarMock;
æˆ–è€…ç°¡å–®åœ¨æ¸¬è©¦æª”ä¸­ç›´æ¥ mockï¼š

ts
jest.mock('chokidar', () => {
  const onFn = jest.fn();
  const mockWatcher = {
    on: onFn,
  };
  return {
    watch: jest.fn(() => mockWatcher),
    __mockWatcher: mockWatcher,
    __onFn: onFn,
  };
});

âœ… å®Œæ•´æ¸¬è©¦ï¼šè§¸ç™¼ reload + é©—è­‰ loadConfig è¢«å‘¼å«
ts
import { Test, TestingModule } from '@nestjs/testing';
import { ServerConfigService } from './server-config.service';
import * as mockFs from 'mock-fs';
import * as fs from 'fs';
import * as path from 'path';
import chokidar from 'chokidar'; // æ­¤è™•æœƒè‡ªå‹•å°å…¥ mock
import { jest } from '@jest/globals';

const mockConfigPath = path.resolve('/etc/config/server.json');

const mockJsonV1 = JSON.stringify({
  DEV: { 'MY-LAB-ENV': { SERVER1: '1.1.1.1' } },
});

const mockJsonV2 = JSON.stringify({
  DEV: { 'MY-LAB-ENV': { SERVER1: '2.2.2.2' } },
});

describe('ServerConfigService - chokidar reload', () => {
  let service: ServerConfigService;

  beforeEach(async () => {
    // åˆå§‹ mock æª”æ¡ˆå…§å®¹
    mockFs({
      '/etc/config': {
        'server.json': mockJsonV1,
      },
    });

    const module: TestingModule = await Test.createTestingModule({
      providers: [ServerConfigService],
    }).compile();

    service = module.get<ServerConfigService>(ServerConfigService);
  });

  afterEach(() => {
    mockFs.restore();
    jest.clearAllMocks();
  });

  it('should call loadConfig when chokidar emits change', async () => {
    const loadSpy = jest.spyOn(service as any, 'loadConfig');

    // æ¨¡æ“¬æª”æ¡ˆè®Šæ›´
    const chokidarModule = await import('chokidar') as any;
    const watcherOn = chokidarModule.__onFn as jest.Mock;

    // å–å¾—è¨»å†Šçš„ on('change', cb)
    const changeCallback = watcherOn.mock.calls.find(call => call[0] === 'change')?.[1];
    expect(typeof changeCallback).toBe('function');

    // æ›´æ–° mockFs çš„å…§å®¹ï¼Œæ¨¡æ“¬æª”æ¡ˆè®Šæ›´
    mockFs({
      '/etc/config': {
        'server.json': mockJsonV2,
      },
    });

    // æ‰‹å‹•å‘¼å«æ¨¡æ“¬çš„ change callbackï¼ˆæ¨¡æ“¬ chokidar åµæ¸¬åˆ°æ”¹å‹•ï¼‰
    changeCallback();

    // é©—è­‰ loadConfig æœ‰è¢«å‘¼å«
    expect(loadSpy).toHaveBeenCalled();
    expect(service.getServerIpStrict('DEV', 'MY-LAB-ENV', 'SERVER1')).toBe('2.2.2.2');
  });
});
âœ… æ¸¬è©¦èªªæ˜
é‡é»	èªªæ˜
jest.mock('chokidar')	æ””æˆª chokidar çœŸæ­£çš„è¡Œç‚º
watch().on() è¢«æ¨¡æ“¬	å¯æ‰‹å‹•è§¸ç™¼ change äº‹ä»¶
jest.spyOn(service, 'loadConfig')	ç›£æ§æœ‰æ²’æœ‰æ­£ç¢º reload
mockFs æ¨¡æ“¬æª”æ¡ˆå…§å®¹æ›´æ–°	æ¸¬è©¦ reload çµæœæ˜¯å¦æ­£ç¢º

ğŸ§ª æ¸¬è©¦é€šéæ¢ä»¶
loadConfig() æœƒå›  change è¢«å‘¼å«

getServerIpStrict() å–å¾—çš„æ˜¯æ›´æ–°å¾Œçš„ IP (2.2.2.2)

æ²’æœ‰çœŸæ­£è§¸ç™¼ file system watchï¼Œä½†é‚è¼¯ç¢ºå¯¦åŸ·è¡Œ

âš ï¸ å°æé†’
å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ esm æ¨¡å¼ï¼Œéœ€è¦ä½¿ç”¨ jest.mock(...) æ™‚ç¢ºä¿ç”¨ babel-jest æˆ–è¨­å¥½ ts-jest

chokidar mock è‹¥æ”¾åœ¨å…¨åŸŸæ¸¬è©¦å¥—ä»¶ä¸­ï¼Œä¹Ÿèƒ½é‡è¤‡ä½¿ç”¨

